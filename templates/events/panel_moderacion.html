{% extends "base.html" %}

{% block content %}
<div class="w3-container" style="max-width:1100px; margin-top:80px;">

    <h2 class="w3-text-theme">Panel de administración</h2>
    <p class="w3-small w3-text-grey">
        Solo usuarios con rol <strong>administrador</strong> (o staff/superuser) pueden ver este panel.
    </p>

    {# ---------------------- Eventos pendientes ---------------------- #}
    <div class="w3-card w3-white w3-margin-bottom">
        <header class="w3-container w3-theme-l3">
            <h4 style="margin:8px 0;">Eventos pendientes de aprobación</h4>
        </header>
        <div class="w3-container w3-padding">
            {% if eventos_pendientes %}
                <table class="w3-table w3-bordered w3-white w3-small">
                    <tr class="w3-theme-l4">
                        <th>Título</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Creado por</th>
                        <th>Acciones</th>
                    </tr>
                    {% for evento in eventos_pendientes %}
                        <tr>
                            <td>
                                <a href="{% url 'events:detalle' evento.pk %}">
                                    {{ evento.titulo }}
                                </a>
                            </td>
                            <td>{{ evento.fecha|date:"d/m/Y" }}</td>
                            <td>{{ evento.hora|time:"H:i" }}</td>
                            <td>{{ evento.creado_por }}</td>
                            <td>
                                <a href="{% url 'events:aprobar' evento.pk %}"
                                   class="w3-button w3-small w3-green w3-round-large"
                                   style="margin-right:4px;">
                                    Aprobar
                                </a>
                                <a href="{% url 'events:rechazar' evento.pk %}"
                                   class="w3-button w3-small w3-red w3-round-large">
                                    Rechazar
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            {% else %}
                <p class="w3-text-grey w3-small" style="margin:8px 0;">
                    No hay eventos pendientes de aprobación.
                </p>
            {% endif %}
        </div>
    </div>

    {# ---------------------- Gestión de usuarios ---------------------- #}
    <div class="w3-card w3-white">
        <header class="w3-container w3-theme-l3">
            <h4 style="margin:8px 0;">Gestión de usuarios</h4>
        </header>

        <div class="w3-container w3-padding">

            <h5>Crear nuevo usuario</h5>
            <form method="post" action="{% url 'events:crear_usuario_admin' %}" class="w3-row-padding">
                {% csrf_token %}
                <div class="w3-third">
                    <label>Nombre de usuario</label>
                    <input type="text" name="username" class="w3-input w3-border" required>
                </div>
                <div class="w3-third">
                    <label>Correo electrónico</label>
                    <input type="email" name="email" class="w3-input w3-border">
                </div>
                <div class="w3-third">
                    <label>Rol</label>
                    <select name="rol" class="w3-select w3-border" required>
                        <option value="" disabled selected>Selecciona rol</option>
                        <option value="vecino">Vecino</option>
                        <option value="moderador">Moderador</option>
                        <option value="administrador">Administrador</option>
                    </select>
                </div>

                <div class="w3-third" style="margin-top:8px;">
                    <label>Contraseña</label>
                    <input type="password" name="password1" class="w3-input w3-border" required>
                </div>
                <div class="w3-third" style="margin-top:8px;">
                    <label>Repetir contraseña</label>
                    <input type="password" name="password2" class="w3-input w3-border" required>
                </div>
                <div class="w3-third" style="margin-top:30px;">
                    <button type="submit"
                            class="w3-button w3-theme w3-round-large w3-small">
                        Crear usuario
                    </button>
                </div>
            </form>

            <hr>

            <h5>Usuarios registrados</h5>
            {% if usuarios %}
                <table class="w3-table w3-bordered w3-small">
                    <tr class="w3-theme-l4">
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Rol actual</th>
                        <th>Cambiar rol</th>
                    </tr>
                    {% for u in usuarios %}
                        <tr>
                            <td>{{ u.username }}</td>
                            <td>{{ u.email }}</td>
                            <td>{{ u.rol|default:"(sin rol)" }}</td>
                            <td>
                                <form method="post"
                                      action="{% url 'events:cambiar_rol_usuario' u.pk %}"
                                      class="w3-row-padding" style="margin:0;">
                                    {% csrf_token %}
                                    <div class="w3-half">
                                        <select name="rol" class="w3-select w3-border w3-small" required>
                                            <option value="vecino" {% if u.rol == "vecino" %}selected{% endif %}>Vecino</option>
                                            <option value="moderador" {% if u.rol == "moderador" %}selected{% endif %}>Moderador</option>
                                            <option value="administrador" {% if u.rol == "administrador" %}selected{% endif %}>Administrador</option>
                                        </select>
                                    </div>
                                    <div class="w3-half">
                                        <button type="submit"
                                                class="w3-button w3-small w3-theme w3-round-large"
                                                style="margin-top:2px;">
                                            Guardar
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            {% else %}
                <p class="w3-text-grey w3-small">
                    No hay usuarios registrados.
                </p>
            {% endif %}

        </div>
    </div>

</div>
{% endblock %}
